ARG NODE_VERSION=22.13.1

FROM node:${NODE_VERSION}-alpine

ENV NODE_ENV="production" \
    PORT="2525" \
    UMASK="0002" \
    TZ="Etc/UTC"

WORKDIR /app

# Copy package files first for better layer caching
COPY package*.json ./

# Install production dependencies
RUN npm install --omit=dev

# Copy application source
COPY config.js server.js ./
COPY services/ ./services/

# Create necessary directories and set permissions
RUN mkdir -p logs temp-attachments \
 && chown -R node:node /app

USER node
EXPOSE 2525
CMD ["node", "server.js"]
LABEL org.opencontainers.image.source="https://github.com/theviktor/inbound-email"